<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Docs Generator with Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="api-error-banner" class="hidden bg-red-600 text-white p-4 text-center fixed top-0 left-0 w-full z-[2000]">
        <!-- Content will be set by JS -->
    </div>

    <div class="container mx-auto p-4 md:p-8 pt-20">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-gray-900">AI-Powered Google Docs Generator</h1>
            <p class="text-gray-600 mt-2">Create Google Docs from any text, powered by Gemini.</p>
            <button id="accountBtn" class="absolute top-0 right-0 bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-200 transition">Account</button>
        </header>

        <!-- Main Content Area -->
        <div id="app-content" class="max-w-2xl mx-auto hidden">
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Link Your Google Account</h2>
                <p id="google-auth-status" class="mb-4 text-gray-600">You need to authorize the app to create Google Docs for you.</p>
                <button id="authorize_button" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all">Link Google Account</button>
                <button id="signout_button" class="hidden bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition-all">Unlink Google Account</button>
            </div>
            
            <div id="doc-generator" class="bg-white p-6 rounded-xl shadow-md hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-gray-800">2. Create Your Document</h2>
                 <input type="text" id="doc-title" placeholder="Enter document title" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                 <textarea id="doc-content" rows="10" placeholder="Enter your content here. You can use the AI to expand on it!" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                 <div class="flex flex-col sm:flex-row gap-3 mt-4">
                    <button id="generate-doc-btn" class="flex-1 bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-all">Create Google Doc</button>
                    <button id="ai-enhance-btn" class="flex-1 bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-all">âœ¨ Enhance with AI</button>
                 </div>
                 <p id="generator-status" class="mt-4 text-center"></p>
            </div>
        </div>

        <div id="auth-prompt" class="text-center p-10 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-gray-800">Welcome!</h2>
            <p class="mt-2 text-gray-600">Please sign in to use the Google Docs generator.</p>
        </div>
    </div>

    <!-- Account Popup (Re-used from Kanban App) -->
    <div id="overlay" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 hidden z-[1000]"></div>
    <div id="accountPopup" class="popup-content hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[1001]">
         <button id="closeAccountPopupBtn" class="absolute top-2 right-4 text-2xl font-bold">&times;</button>
        <div id="signInForm">
            <h3 class="text-2xl font-bold mb-4">Sign In</h3>
            <input type="email" id="signInEmail" placeholder="Email" class="w-full p-2 mb-3 border rounded">
            <input type="password" id="signInPassword" placeholder="Password" class="w-full p-2 mb-4 border rounded">
            <button id="signInBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Sign In</button>
            <p id="errorMessage" class="text-red-500 mt-2 hidden"></p>
            <p class="mt-4">Don't have an account? <a href="#" id="showSignUpBtn" class="text-blue-500">Sign Up</a></p>
        </div>
        <div id="signUpForm" class="hidden">
            <h3 class="text-2xl font-bold mb-4">Sign Up</h3>
            <input type="email" id="signUpEmail" placeholder="Email" class="w-full p-2 mb-3 border rounded">
            <input type="password" id="signUpPassword" placeholder="Password (min. 6 chars)" class="w-full p-2 mb-4 border rounded">
            <button id="signUpBtn" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Sign Up</button>
            <p id="errorMessageSignUp" class="text-red-500 mt-2 hidden"></p>
            <p class="mt-4">Already have an account? <a href="#" id="showSignInBtn" class="text-blue-500">Sign In</a></p>
        </div>
        <div id="accountActions" class="hidden">
            <h3 class="text-2xl font-bold mb-4">My Account</h3>
            <p class="mb-2"><strong>Email:</strong> <span id="accountUserEmail"></span></p>
            <p class="mb-4"><strong>Plan:</strong> <span id="accountUserPlan"></span></p>
            <button id="signOutBtn" class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600">Sign Out</button>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://zxeikhguvghtsqouyuyz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4ZWlraGd1dmdodHNxb3V5dXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1ODYyMzAsImV4cCI6MjA2NzE2MjIzMH0.a9jWr_h1dgyi_ST7sgKDASDHi7hkMjSWOR78Vq2fMN0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GOOGLE API CONFIG ---
        const GOOGLE_API_KEY = 'AIzaSyAUIv4HEMufF0x51eZqLpeoRtJX8Wnrnio';
        const GOOGLE_CLIENT_ID = '467122347195-5gg9ei8ahfle0ttse6jslt2kkhimlkk1.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://docs.googleapis.com/$discovery/rest?version=v1';
        const SCOPES = 'https://www.googleapis.com/auth/documents';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // --- AUTH MANAGER (Adapted from Kanban App) ---
        class AuthManager {
            constructor() {
                this.user = null;
                this.session = null;
                this.hasActiveSubscription = false;
                this.userPlan = 'free';
            }

            async initializeAuth() {
                this.setupAuthEventListeners();
                supabase.auth.onAuthStateChange(async (event, session) => {
                    this.session = session;
                    this.user = session?.user || null;
                    if (this.user) {
                        await this.loadUsage();
                    }
                    this.updateUI();
                });
            }

            setupAuthEventListeners() {
                document.getElementById('accountBtn').addEventListener('click', () => this.toggleAccountPopup());
                document.getElementById('signInBtn').addEventListener('click', () => this.handleSignIn());
                document.getElementById('signUpBtn').addEventListener('click', () => this.handleSignUp());
                document.getElementById('showSignUpBtn').addEventListener('click', (e) => { e.preventDefault(); this.showSignUpForm(); });
                document.getElementById('showSignInBtn').addEventListener('click', (e) => { e.preventDefault(); this.showSignInForm(); });
                document.getElementById('signOutBtn').addEventListener('click', () => this.handleSignOut());
                document.getElementById('closeAccountPopupBtn').addEventListener('click', () => this.closeAccountPopup());
                document.getElementById('overlay').addEventListener('click', () => this.closeAccountPopup());
            }
            
            async loadUsage() {
                this.hasActiveSubscription = false;
                this.userPlan = 'free';
                if (!this.user) return;
                try {
                    const { data } = await supabase.from('user_subscriptions').select('status').eq('user_id', this.user.id).in('status', ['active', 'pending']);
                    this.hasActiveSubscription = data && data.length > 0;
                    this.userPlan = this.hasActiveSubscription ? 'pro' : 'free';
                } catch (error) {
                    console.error('Usage check failed:', error);
                } finally {
                    this.updateAccountPopupUI();
                }
            }

            updateUI() {
                const isLoggedIn = !!this.user;
                document.getElementById('app-content').classList.toggle('hidden', !isLoggedIn);
                document.getElementById('auth-prompt').classList.toggle('hidden', isLoggedIn);
                this.updateAccountPopupUI();
            }

            updateAccountPopupUI() {
                if (this.user) {
                    document.getElementById('accountUserEmail').textContent = this.user.email;
                    document.getElementById('accountUserPlan').textContent = this.userPlan === 'pro' ? 'Pro Plan' : 'Free Plan';
                    document.getElementById('signInForm').classList.add('hidden');
                    document.getElementById('signUpForm').classList.add('hidden');
                    document.getElementById('accountActions').classList.remove('hidden');
                } else {
                    document.getElementById('accountActions').classList.add('hidden');
                    this.showSignInForm();
                }
            }
            
            toggleAccountPopup() {
                const popup = document.getElementById('accountPopup');
                const overlay = document.getElementById('overlay');
                popup.classList.toggle('hidden');
                overlay.classList.toggle('hidden');
                if (!popup.classList.contains('hidden')) this.updateAccountPopupUI();
            }
            closeAccountPopup() {
                document.getElementById('accountPopup').classList.add('hidden');
                document.getElementById('overlay').classList.add('hidden');
            }
            showSignUpForm() {
                document.getElementById('signInForm').classList.add('hidden');
                document.getElementById('signUpForm').classList.remove('hidden');
            }
            showSignInForm() {
                document.getElementById('signUpForm').classList.add('hidden');
                document.getElementById('signInForm').classList.remove('hidden');
            }
            async handleSignIn() {
                const email = document.getElementById('signInEmail').value;
                const password = document.getElementById('signInPassword').value;
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) alert(error.message); else this.closeAccountPopup();
            }
            async handleSignUp() {
                const email = document.getElementById('signUpEmail').value;
                const password = document.getElementById('signUpPassword').value;
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) alert(error.message); else alert('Check your email for a confirmation link!');
            }
            async handleSignOut() { await supabase.auth.signOut(); }
        }

        // --- MAIN APP LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const authManager = new AuthManager();
            authManager.initializeAuth();

            // --- GOOGLE DOCS GENERATOR LOGIC ---
            const authorizeButton = document.getElementById('authorize_button');
            const signoutButton = document.getElementById('signout_button');
            const generateDocBtn = document.getElementById('generate-doc-btn');
            const aiEnhanceBtn = document.getElementById('ai-enhance-btn');
            const statusEl = document.getElementById('generator-status');

            // --- Google API Initialization ---
            function gapiLoaded() {
                gapi.load('client', initializeGapiClient);
            }
            async function initializeGapiClient() {
                try {
                    await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                    gapiInited = true;
                } catch (error) {
                    console.error("Error initializing GAPI client:", error);
                    const apiErrorBanner = document.getElementById('api-error-banner');
                    
                    if (error && error.result && error.result.error && error.result.error.status === 'PERMISSION_DENIED') {
                        const details = error.result.error.details || [];
                        const serviceDisabledInfo = details.find(d => d.reason === 'SERVICE_DISABLED');
                        if (serviceDisabledInfo) {
                            const activationUrl = serviceDisabledInfo.metadata.activationUrl;
                            apiErrorBanner.innerHTML = `<strong>Action Required:</strong> The Google Docs API is not enabled in your Google Cloud project. Please click this link to enable it, then refresh the page: <a href="${activationUrl}" target="_blank" class="text-blue-300 hover:underline font-bold">Enable API</a>`;
                            apiErrorBanner.classList.remove('hidden');
                            return;
                        }
                    }
                    
                    apiErrorBanner.innerHTML = `<strong>Configuration Error:</strong> Could not initialize Google API. Please verify your API Key in the source code.`;
                    apiErrorBanner.classList.remove('hidden');
                }
            }
            function gisLoaded() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // defined later
                });
                gisInited = true;
            }
            gapiLoaded();
            
            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.async = true;
            gisScript.defer = true;
            gisScript.onload = gisLoaded;
            document.body.appendChild(gisScript);

            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;

            function handleAuthClick() {
                if (!gapiInited || !gisInited) {
                    alert("Google API scripts are still loading. Please wait a moment and try again.");
                    return;
                }
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        console.error("Google Auth Error:", resp);
                        throw (resp);
                    }
                    updateGoogleAuthUI(true);
                };
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }

            function handleSignoutClick() {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                    updateGoogleAuthUI(false);
                }
            }

            function updateGoogleAuthUI(isAuthorized) {
                const authStatusEl = document.getElementById('google-auth-status');
                const docGeneratorEl = document.getElementById('doc-generator');
                if (isAuthorized) {
                    authorizeButton.classList.add('hidden');
                    signoutButton.classList.remove('hidden');
                    docGeneratorEl.classList.remove('hidden');
                    authStatusEl.textContent = 'Your Google account is linked successfully!';
                    authStatusEl.style.color = 'green';
                } else {
                    authorizeButton.classList.remove('hidden');
                    signoutButton.classList.add('hidden');
                    docGeneratorEl.classList.add('hidden');
                    authStatusEl.textContent = 'You need to authorize the app to create Google Docs for you.';
                    authStatusEl.style.color = '';
                }
            }

            // --- Document Creation and AI Enhancement ---
            generateDocBtn.addEventListener('click', async () => {
                const title = document.getElementById('doc-title').value.trim();
                const content = document.getElementById('doc-content').value.trim();
                if (!title || !content) {
                    statusEl.textContent = 'Please provide a title and content.';
                    statusEl.style.color = 'red';
                    return;
                }
                statusEl.textContent = 'Creating document...';
                statusEl.style.color = 'blue';
                try {
                    const doc = await gapi.client.docs.documents.create({ body: { title } });
                    await gapi.client.docs.documents.batchUpdate({
                        documentId: doc.result.documentId,
                        resource: {
                            requests: [{ insertText: { location: { index: 1 }, text: content } }]
                        }
                    });
                    statusEl.textContent = `Document created successfully!`;
                    statusEl.style.color = 'green';
                    const docLink = `https://docs.google.com/document/d/${doc.result.documentId}/edit`;
                    statusEl.innerHTML += ` <a href="${docLink}" target="_blank" class="text-blue-600 hover:underline">Open Document</a>`;

                } catch (err) {
                    statusEl.textContent = `Error: ${err.result.error.message}`;
                    statusEl.style.color = 'red';
                    console.error(err);
                }
            });

            const callGeminiApi = async (prompt) => {
                statusEl.textContent = 'AI is enhancing your text...';
                statusEl.style.color = 'purple';
                const apiKey = ""; // Leave empty for Canvas environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                    const result = await response.json();
                    const enhancedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (enhancedText) {
                        document.getElementById('doc-content').value = enhancedText;
                        statusEl.textContent = 'Text enhanced successfully!';
                        statusEl.style.color = 'green';
                    } else {
                        throw new Error('No content returned from AI.');
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    statusEl.textContent = `Error enhancing text: ${error.message}`;
                    statusEl.style.color = 'red';
                }
            };

            aiEnhanceBtn.addEventListener('click', async () => {
                const contentEl = document.getElementById('doc-content');
                const originalContent = contentEl.value.trim();
                if (!originalContent) {
                    statusEl.textContent = 'Please enter some content to enhance.';
                    statusEl.style.color = 'red';
                    return;
                }
                const prompt = `You are a helpful writing assistant. Take the following text and expand upon it, making it more detailed, professional, and well-structured. Do not add any introductory or concluding remarks, just provide the enhanced text. Original text: "${originalContent}"`;
                await callGeminiApi(prompt);
            });
        });
    </script>
</body>
</html>
