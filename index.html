<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Orbit - AI Workspace | Generate professional documents with AI assistance. Create, enhance, and manage Google Docs effortlessly.">
    <meta name="keywords" content="AI document generator, Google Docs, content creation, writing assistant, productivity tool">
    <meta name="author" content="Orbit AI">
    <meta property="og:title" content="Orbit - AI Workspace | Smart Document Generator">
    <meta property="og:description" content="Create professional documents with AI assistance in seconds.">
    <meta property="og:type" content="website">
    <title>Orbit - AI Workspace</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/alliswells/Project-Orbit/main/img/orbit.png" type="image/png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS with Dark Mode -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            primary: '#161618',
                            secondary: '#242628',
                            tertiary: '#a1a1a2',
                            light: '#fcfcfc'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    },
                    animation: {
                        'fade-up': 'fade-up 0.5s ease-out',
                        'fade-in': 'fade-in 0.3s ease-out',
                        'text-reveal': 'text-reveal 1.5s ease-out forwards',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        'fade-up': {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        'text-reveal': {
                            '0%': { 'background-size': '0% 100%' },
                            '100%': { 'background-size': '100% 100%' }
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Required APIs -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        body {
            background-color: #161618;
            color: #fcfcfc;
        }
        
        .glassmorphism {
            background: rgba(22, 22, 24, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(36, 38, 40, 0.5);
        }
        
        .btn-micro:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(6, 178, 252, 0.3);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        .service-icon.grayscale {
            filter: grayscale(100%);
        }
        
        .hidden { display: none; }
        
        .popup-content {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161618; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Loader animation */
        .loader {
            width: 50px;
            aspect-ratio: 1;
            box-shadow: 0 0 0 3px #06b2fc inset;
            border-radius: 50%;
            position: relative;
            animation: l6 1.5s linear infinite;
        }
        .loader:before {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inherit;
            width: 25px;
            aspect-ratio: 1;
            border-radius: 50%;
        }
        @keyframes l6 {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans antialiased bg-dark-primary text-dark-light min-h-screen">
    <!-- 3D Background Canvas -->
    <div id="canvas-container" class="fixed inset-0 -z-10 opacity-20"></div>
    
    <!-- API Error Banner -->
    <div id="api-error-banner" class="hidden bg-red-600 text-white p-4 text-center fixed top-0 left-0 w-full z-[2000] glassmorphism"></div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 md:px-8 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-12 animate-fade-up">
            <div class="flex items-center gap-3">
                 <img src="https://raw.githubusercontent.com/alliswells/Project-Orbit/main/img/logo.png" alt="Orbit Logo" class="w-20 h-100%">
            </div>
            <button id="accountBtn" class="bg-dark-secondary text-dark-light font-medium py-2 px-4 rounded-lg hover:bg-dark-tertiary transition-all flex items-center gap-2 btn-micro">
                <span id="accountBtnText">Account</span>
                <span id="proBadge" class="hidden bg-[#06b2fc] text-white text-xs font-bold px-2 py-1 rounded-full">PRO</span>
            </button>
        </header>

        <!-- Main Content Area -->
        <div id="app-content" class="max-w-4xl mx-auto animate-fade-up" style="animation-delay: 0.1s">
            <div class="glassmorphism p-8 rounded-2xl shadow-xl">
                <!-- NEW: Workspace Connector with Icons -->
                <div id="workspace-connector" class="mb-12 text-center">
                    <h2 class="text-3xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">Connect Your Workspace</h2>
                    <p class="mb-8 text-dark-tertiary">Link your Google Account to enable the AI-powered tools.</p>
                    <div id="google-services-icons" class="flex justify-center items-center gap-4 md:gap-8 flex-wrap">
                        <!-- Google Docs Icon -->
                        <a href="#" class="service-icon-link text-center no-underline" data-service="docs">
                            <div class="service-icon p-4 bg-dark-secondary rounded-2xl transition-all duration-300 cursor-pointer card-hover">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/01/Google_Docs_logo_%282020%29.svg/1024px-Google_Docs_logo_%282020%29.svg.png" alt="Google Docs" class="h-12 w-12" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Docs';">
                            </div>
                            <p class="mt-2 text-sm text-dark-tertiary">Docs</p>
                        </a>
                        <!-- Google Sheets Icon -->
                        <a href="#" class="service-icon-link text-center no-underline" data-service="sheets">
                             <div class="service-icon p-4 bg-dark-secondary rounded-2xl transition-all duration-300 cursor-pointer card-hover">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Google_Sheets_logo_%282020%29.svg/1024px-Google_Sheets_logo_%282020%29.svg.png" alt="Google Sheets" class="h-12 w-12" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Sheets';">
                            </div>
                             <p class="mt-2 text-sm text-dark-tertiary">Sheets</p>
                        </a>
                        <!-- Google Slides Icon -->
                        <a href="#" class="service-icon-link text-center no-underline" data-service="slides">
                            <div class="service-icon p-4 bg-dark-secondary rounded-2xl transition-all duration-300 cursor-pointer card-hover">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/Google_Slides_logo_%282020%29.svg/1024px-Google_Slides_logo_%282020%29.svg.png" alt="Google Slides" class="h-12 w-12" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Slides';">
                            </div>
                            <p class="mt-2 text-sm text-dark-tertiary">Slides</p>
                        </a>
                        <!-- Google Forms Icon -->
                        <a href="#" class="service-icon-link text-center no-underline" data-service="forms">
                            <div class="service-icon p-4 bg-dark-secondary rounded-2xl transition-all duration-300 cursor-pointer card-hover">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Google_Forms_logo_%282020%29.svg/1024px-Google_Forms_logo_%282020%29.svg.png" alt="Google Forms" class="h-12 w-12" onerror="this.onerror=null; this.src='https://placehold.co/48x48/242628/fcfcfc?text=Forms';">
                            </div>
                            <p class="mt-2 text-sm text-dark-tertiary">Forms</p>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Features Section -->
            <div class="mt-16 glassmorphism p-8 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold mb-8 text-center text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">Powerful Features</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-dark-secondary p-6 rounded-xl card-hover">
                        <div class="w-12 h-12 bg-[#06b2fc]/20 rounded-lg flex items-center justify-center mb-4">
                            <svg class="w-6 h-6 text-[#06b2fc]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Instant Document Creation</h3>
                        <p class="text-dark-tertiary text-sm">Generate professional Google Docs in seconds with our streamlined interface.</p>
                    </div>
                    <div class="bg-dark-secondary p-6 rounded-xl card-hover">
                        <div class="w-12 h-12 bg-[#06b2fc]/20 rounded-lg flex items-center justify-center mb-4">
                            <svg class="w-6 h-6 text-[#06b2fc]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">AI Content Enhancement</h3>
                        <p class="text-dark-tertiary text-sm">Transform rough ideas into polished content with our advanced AI.</p>
                    </div>
                    <div class="bg-dark-secondary p-6 rounded-xl card-hover">
                        <div class="w-12 h-12 bg-[#06b2fc]/20 rounded-lg flex items-center justify-center mb-4">
                             <svg class="w-6 h-6 text-[#06b2fc]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Secure Cloud Sync</h3>
                        <p class="text-dark-tertiary text-sm">All documents are securely saved to your Google Drive automatically.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Popup -->
    <div id="overlay" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 hidden z-[1000] backdrop-blur-sm"></div>
    <div id="accountPopup" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm z-[1001] hidden">
        <div class="bg-dark-secondary rounded-xl shadow-2xl p-6 relative border border-dark-tertiary/30 mx-4 popup-content">
            <button id="closeAccountPopupBtn" class="absolute top-4 right-4 text-dark-tertiary hover:text-dark-light transition text-2xl leading-none">&times;</button>
            
            <!-- Logged Out View -->
            <div id="loggedOutView">
                <div id="signInForm">
                    <h3 class="text-2xl font-bold mb-6 text-dark-light">Sign In</h3>
                    <input type="email" id="signInEmail" placeholder="Email" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <input type="password" id="signInPassword" placeholder="Password" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <button id="signInBtn" class="w-full bg-[#06b2fc] text-white p-3 rounded-lg hover:bg-[#0595d8] transition-all mb-4">Sign In</button>
                    <p id="signInError" class="text-red-400 mt-2 text-sm hidden"></p>
                    <p class="mt-4 text-sm text-dark-tertiary">Don't have an account? <a href="#" id="showSignUpBtn" class="text-[#06b2fc] font-medium hover:underline">Sign Up</a></p>
                </div>
                <div id="signUpForm" class="hidden">
                    <h3 class="text-2xl font-bold mb-6 text-dark-light">Create Account</h3>
                    <input type="email" id="signUpEmail" placeholder="Email" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <input type="password" id="signUpPassword" placeholder="Password (min. 6 chars)" class="w-full p-3 mb-4 bg-dark-primary border border-dark-tertiary rounded-lg text-dark-light placeholder-dark-tertiary focus:outline-none focus:ring-2 focus:ring-[#06b2fc]">
                    <button id="signUpBtn" class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white p-3 rounded-lg hover:from-green-600 hover:to-teal-600 transition-all mb-4">Sign Up</button>
                    <p id="signUpError" class="text-red-400 mt-2 text-sm hidden"></p>
                    <p class="mt-4 text-sm text-dark-tertiary">Already have an account? <a href="#" id="showSignInBtn" class="text-[#06b2fc] font-medium hover:underline">Sign In</a></p>
                </div>
            </div>

            <!-- Logged In View -->
            <div id="accountActions" class="hidden">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-full bg-[#06b2fc] flex items-center justify-center text-white font-bold">
                        <span id="accountInitials"></span>
                    </div>
                    <div>
                        <h3 class="font-bold text-dark-light">My Account</h3>
                        <p class="text-sm text-dark-tertiary" id="accountUserEmail"></p>
                    </div>
                </div>
                
                <div class="bg-dark-primary p-4 rounded-lg mb-6 border border-dark-tertiary/20">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-dark-tertiary">Current Plan</span>
                        <span id="accountUserPlan" class="text-sm font-bold text-[#06b2fc]"></span>
                    </div>
                    <div class="h-2 bg-dark-secondary rounded-full mb-2 overflow-hidden">
                        <div id="usageBar" class="h-full bg-[#06b2fc] rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="upgrade-prompt" class="text-xs text-dark-tertiary">Upgrade to Pro for unlimited documents and AI features.</p>
                </div>
                
                <button id="upgradeToProBtn" class="w-full bg-[#06b2fc] text-white p-3 rounded-lg hover:bg-[#0595d8] transition-all mb-3">Upgrade to Pro</button>
                <button id="signOutBtn" class="w-full bg-dark-primary text-dark-light p-3 rounded-lg hover:bg-dark-tertiary/20 transition-all border border-dark-tertiary/30">Sign Out</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Skeleton -->
    <div id="loading-skeleton" class="fixed inset-0 bg-dark-primary/90 z-[2000] flex items-center justify-center hidden">
        <div class="loader"></div>
    </div>
    
<script>
    // --- KEY DEOBFUSCATION ---
    const deobfuscate = (key) => key.replace(/\*/g, '');

    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://zxeikhguvghtsqouyuyz.supabase.co';
    const SUPABASE_ANON_KEY_OBFUSCATED = 'e*y*J*h*b*G*c*i*O*i*J*I*U*z*I*1*N*i*I*s*I*n*R*5*c*C*I*6*I*k*p*X*V*C*J*9*.*e*y*J*p*c*3*M*i*O*i*J*z*d*X*B*h*Y*m*F*z*Z*S*I*s*I*n*J*l*Z*i*I*6*I*n*p*4*Z*W*l*r*a*G*d*1*d*m*d*o*d*H*N*x*b*3*V*5*d*X*l*6*I*i*w*i*c*m*9*s*Z*S*I*6*I*m*F*u*b*2*4*i*L*C*J*p*Y*X*Q*i*O*j*E*3*N*T*E*1*O*D*Y*y*M*z*A*s*I*m*V*4*c*C*I*6*M*j*A*2*N*z*E*2*M*j*I*z*M*H*0*.*a*9*j*W*r*_*h*1*d*g*y*i*_*S*T*7*s*g*K*D*A*S*D*H*i*7*h*k*M*j*S*W*O*R*7*8*V*q*2*f*M*N*0';
    const supabase = window.supabase.createClient(SUPABASE_URL, deobfuscate(SUPABASE_ANON_KEY_OBFUSCATED));
    
    const STRIPE_PUBLISHABLE_KEY_OBFUSCATED = 'p*k*_*t*e*s*t*_*5*1*R*8*v*i*v*G*r*s*d*J*U*1*d*j*q*O*m*J*c*5*5*2*p*6*s*q*z*K*V*m*1*Q*p*r*L*I*R*a*l*h*n*a*J*m*i*e*7*3*H*c*6*A*o*j*0*j*V*G*G*J*m*I*x*B*K*1*z*6*H*p*H*I*B*Q*Y*m*e*V*A*B*B*E*p*Q*S*8*8*0*0*w*g*y*G*p*O*4*y';
    const stripe = Stripe(deobfuscate(STRIPE_PUBLISHABLE_KEY_OBFUSCATED));

    // --- GOOGLE API CONFIG ---
    const GOOGLE_API_KEY_OBFUSCATED = 'A*I*z*a*S*y*A*U*I*v*4*H*E*M*u*f*F*0*x*5*1*e*Z*q*L*p*e*o*R*t*J*X*8*W*n*r*n*i*o';
    const GOOGLE_CLIENT_ID_OBFUSCATED = '4*6*7*1*2*2*3*4*7*1*9*5*-*5*g*g*9*e*i*8*a*h*f*l*e*0*t*t*s*e*6*j*s*l*t*2*k*k*h*i*m*l*k*k*1*.*a*p*p*s*.*g*o*o*g*l*e*u*s*e*r*c*o*n*t*e*n*t*.*c*o*m';
    const DISCOVERY_DOC = 'https://docs.googleapis.com/$discovery/rest?version=v1';
    const SCOPES = 'https://www.googleapis.com/auth/documents';

    // --- GLOBAL VARIABLES ---
    let tokenClient;
    let threeJSInitialized = false;
    let pendingService = null; 
    let authManager; 

    // --- AUTH MANAGER CLASS ---
    class AuthManager {
        constructor() {
            this.user = null;
            this.session = null;
            this.hasActiveSubscription = false;
            this.userPlan = 'free';
            this.paymentLoading = false;
            this.documentCount = 0;
            this.maxDocuments = 5;
        }

        async initializeAuth() {
            this.setupAuthEventListeners();
            this.showLoading(true);
            const { data: { session } } = await supabase.auth.getSession();
            this.session = session;
            this.user = session?.user || null;
            
            if (this.user) {
                await this.loadUsage();
            }
            
            this.updateUI();
            this.showLoading(false);

            supabase.auth.onAuthStateChange(async (event, session) => {
                this.session = session;
                this.user = session?.user || null;
                if (this.user) {
                    await this.loadUsage();
                } else {
                    this.handleGoogleSignOut(false);
                }
                this.updateUI();
            });
        }

        showLoading(show) {
            document.getElementById('loading-skeleton').classList.toggle('hidden', !show);
        }

        setupAuthEventListeners() {
            document.getElementById('accountBtn').addEventListener('click', () => this.toggleAccountPopup());
            document.getElementById('signOutBtn').addEventListener('click', () => this.handleSignOut());
            document.getElementById('closeAccountPopupBtn').addEventListener('click', () => this.closeAccountPopup());
            document.getElementById('overlay').addEventListener('click', () => this.closeAccountPopup());
            document.getElementById('upgradeToProBtn').addEventListener('click', () => this.handleUpgrade());
            document.getElementById('signInBtn').addEventListener('click', () => this.handleSignIn());
            document.getElementById('signUpBtn').addEventListener('click', () => this.handleSignUp());
            document.getElementById('showSignUpBtn').addEventListener('click', (e) => { e.preventDefault(); this.showSignUpForm(); });
            document.getElementById('showSignInBtn').addEventListener('click', (e) => { e.preventDefault(); this.showSignInForm(); });
        }
        
        async handleSignIn() { /* No changes */ }
        
        async handleSignUp() { /* No changes */ }

        async handleSignOut() {
            this.showLoading(true);
            if (this.user) {
                await supabase.from('user_google_tokens').delete().eq('user_id', this.user.id);
            }
            await supabase.auth.signOut();
            this.closeAccountPopup();
            this.showLoading(false);
        }

        handleGoogleSignOut(showLoader = true) {
            if(showLoader) this.showLoading(true);
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    updateGoogleAuthUI(false);
                });
            } else {
                 updateGoogleAuthUI(false);
            }
            if(showLoader) this.showLoading(false);
        }

        async handleUpgrade() { /* No changes */ }
        async loadUsage() { /* No changes */ }
        updateUI() {
            this.updateAccountPopupUI();
            if (!threeJSInitialized) {
                initThreeJSBackground();
                initAnimations();
                threeJSInitialized = true;
            }
        }
        updateAccountPopupUI() { /* No changes */ }
        toggleAccountPopup(forceOpen = false) { /* No changes */ }
        closeAccountPopup() { /* No changes */ }
        showSignUpForm() { /* No changes */ }
        showSignInForm() { /* No changes */ }
    }

    // --- VISUALS & ANIMATIONS ---
    function initThreeJSBackground() { /* No changes */ }
    function initAnimations() { /* No changes */ }

    // --- GLOBAL FUNCTIONS ---
    function updateGoogleAuthUI(isAuthorized) {
        const icons = document.querySelectorAll('.service-icon');
        icons.forEach(icon => {
            icon.classList.toggle('grayscale', !isAuthorized);
            icon.classList.toggle('opacity-50', !isAuthorized);
        });
    }

    function handleServiceClick(service) {
        if (!authManager.user) {
            authManager.toggleAccountPopup(true);
            return;
        }

        const isGoogleAuthed = !!gapi.client.getToken();
        if (!isGoogleAuthed) {
            pendingService = service;
            tokenClient.requestAccessToken({ prompt: 'consent' });
            return;
        }

        if (service === 'docs') {
            authManager.showLoading(true);
            window.location.href = './docs.html';
        } else {
            alert(`The ${service.charAt(0).toUpperCase() + service.slice(1)} tool is coming soon!`);
        }
    }

    async function saveGoogleToken(tokenResponse) {
        if (!authManager.user) return;
        const expires_at = new Date(Date.now() + tokenResponse.expires_in * 1000).toISOString();
        const { error } = await supabase
            .from('user_google_tokens')
            .upsert({
                user_id: authManager.user.id,
                access_token: tokenResponse.access_token,
                expires_at: expires_at,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });

        if (error) console.error('Error saving Google token:', error);
    }

    async function loadGoogleToken() {
        if (!authManager.user) {
            updateGoogleAuthUI(false);
            return;
        }

        const { data, error } = await supabase
            .from('user_google_tokens')
            .select('access_token, expires_at')
            .eq('user_id', authManager.user.id)
            .single();

        if (error && error.code !== 'PGRST116') { // Ignore 'no rows found' error
            console.error('Error loading Google token:', error);
            updateGoogleAuthUI(false);
            return;
        }

        if (data && new Date(data.expires_at) > new Date()) {
            gapi.client.setToken({ access_token: data.access_token });
            updateGoogleAuthUI(true);
        } else {
            updateGoogleAuthUI(false);
            if (data) { // Clean up expired token from DB
                await supabase.from('user_google_tokens').delete().eq('user_id', authManager.user.id);
            }
        }
    }

    // --- MAIN APP LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        authManager = new AuthManager();
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: deobfuscate(GOOGLE_API_KEY_OBFUSCATED),
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                const gisScript = document.createElement('script');
                gisScript.src = 'https://accounts.google.com/gsi/client';
                gisScript.async = true;
                gisScript.defer = true;
                gisScript.onload = gisLoaded;
                document.body.appendChild(gisScript);
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
            }
        }

        function gisLoaded() {
            gisInited = true;
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: deobfuscate(GOOGLE_CLIENT_ID_OBFUSCATED),
                scope: SCOPES,
                callback: async (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        await saveGoogleToken(tokenResponse);
                        gapi.client.setToken(tokenResponse);
                        updateGoogleAuthUI(true);

                        if (pendingService) {
                            handleServiceClick(pendingService);
                            pendingService = null;
                        }
                    } else {
                        console.error("Invalid token response:", tokenResponse);
                    }
                },
            });
            authManager.initializeAuth().then(() => {
                loadGoogleToken();
            });
        }

        window.onload = gapiLoaded;
        
        document.querySelectorAll('.service-icon-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                handleServiceClick(link.dataset.service);
            });
        });
    });
</script>
</body>
</html>
